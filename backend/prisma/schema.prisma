generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// -------------------------------------------
// ENUMS - For predefined roles and statuses
// -------------------------------------------
enum Role {
  tnp
  company
  student
}

enum VerificationStatus {
  pending
  verified
  rejected
}

enum JobStatus {
  open
  closed
}

enum DriveStatus {
  upcoming
  ongoing
  completed
}

enum ApplicationStatus {
  applied
  shortlisted
  rejected
  selected
}

// -------------------------------------------
// MODELS
// -------------------------------------------

// Central model for authentication for ALL users
model User {
  id           String   @id
  email        String   @unique
  passwordHash String
  role         Role
  createdAt    DateTime @default(now())

  // Relationships (one-to-one)
  tnpAdmin TnpAdmin?
  company  Company?
  student  Student?
}

// TNP Admin Profile
model TnpAdmin {
  id          String  @id
  user        User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId      String  @unique
  name        String
  phoneNumber String?

  drives Drive[] // A TNP admin can create many drives
}

// Company Profile
model Company {
  id          String  @id
  user        User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId      String  @unique
  companyName String
  companyType String?
  websiteUrl  String?
  hrName      String?

  jobs Job[] // A company can have many job postings
}

// Student's Official Profile
model Student {
  id             String  @id
  user           User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId         String  @unique
  fullName       String
  branch         String?
  batchYear      Int?
  cgpa           Float?
  activeBacklogs Int?    @default(0)
  phoneNumber    String?
  resumeUrl      String?

  resume Resume?

  // AI-generated fields to be used in later phases
  aiPlacementProbability Float?
  aiInterviewScore       Float?

  // Relationships (one-to-many)
  achievements StudentAchievement[]
  internships  StudentInternship[]
  applications Application[]
}

// Student-added achievements
model StudentAchievement {
  id                 String             @id
  student            Student            @relation(fields: [studentId], references: [id], onDelete: Cascade)
  studentId          String
  title              String
  description        String?            @db.Text
  achievementDate    DateTime?
  certificateUrl     String?
  verificationStatus VerificationStatus @default(pending)
}

// Student-added internships
model StudentInternship {
  id             String    @id
  student        Student   @relation(fields: [studentId], references: [id], onDelete: Cascade)
  studentId      String
  role           String
  companyName    String
  startDate      DateTime?
  endDate        DateTime?
  certificateUrl String?
  description    String?   @db.Text
}

// A specific job role posted by a company
model Job {
  id                  Int       @id @default(autoincrement())
  company             Company   @relation(fields: [companyId], references: [id])
  companyId           String
  jobTitle            String
  jobDescription      String    @db.Text
  requiredSkillsText  String?   @db.Text
  eligibilityCgpa     Float?    @default(0.0)
  eligibilityBranches Json? // Store as an array: ["CS", "IT"]
  ctcPaLakhs          Float?
  status              JobStatus @default(open)
  createdAt           DateTime  @default(now())

  // Relationships
  applications Application[]
  drives       Drive[] // A job can be part of multiple drives
}

// A placement drive event created by the TNP
model Drive {
  id         Int         @id @default(autoincrement())
  tnpAdmin   TnpAdmin    @relation(fields: [tnpAdminId], references: [id])
  tnpAdminId String
  driveTitle String
  startDate  DateTime?
  endDate    DateTime?
  status     DriveStatus @default(upcoming)

  // Many-to-many relationship with jobs
  jobs Job[]
}

// Tracks a student's application to a specific job
model Application {
  id              Int               @id @default(autoincrement())
  student         Student           @relation(fields: [studentId], references: [id])
  studentId       String
  job             Job               @relation(fields: [jobId], references: [id])
  jobId           Int
  applicationDate DateTime          @default(now())
  status          ApplicationStatus @default(applied)

  // AI-generated field
  aiMatchScore Float?

  @@unique([studentId, jobId]) // A student can only apply once to the same job
}

model Resume {
  id         String  @id @default(cuid())
  data       Bytes
  resumeText String? @db.Text
  student    Student @relation(fields: [studentId], references: [id], onDelete: Cascade)
  studentId  String  @unique
}
